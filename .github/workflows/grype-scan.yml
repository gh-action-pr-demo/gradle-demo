name: Grype Vulnerability Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  grype-scan:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: -Dorg.gradle.daemon=false
      GRYPE_DB_CACHE_DIR: ~/.cache/grype/db
      GRYPE_FAIL_ON_SEVERITY: high
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build project (fetch dependencies)
        run: ./gradlew --no-daemon clean build

      - name: Prepare Grype cache directory
        run: mkdir -p ~/.cache/grype/db

      - name: Cache Grype vulnerability database
        uses: actions/cache@v4
        with:
          path: ~/.cache/grype/db
          key: grype-db-${{ runner.os }}-v1
          restore-keys: |
            grype-db-${{ runner.os }}-

      - name: Generate CycloneDX SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom.cdx.json

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | \
            sh -s -- -b /usr/local/bin

      - name: Run Grype scan
        id: grype
        continue-on-error: true
        run: |
          set +e
          grype sbom:sbom.cdx.json \
            --fail-on "${GRYPE_FAIL_ON_SEVERITY}" \
            --add-cpes-if-none \
            -o json \
            > grype-report.json
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "Grype exited with code $EXIT_CODE due to detected vulnerabilities."
          else
            echo "Grype completed without hitting the fail-on threshold."
          fi
          exit 0

      - name: Upload SBOM and Grype report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grype-results
          path: |
            sbom.cdx.json
            grype-report.json

      - name: Generate Grype summary & comment
        id: format-report
        if: always()
        env:
          FAIL_ON_SEVERITY: ${{ env.GRYPE_FAIL_ON_SEVERITY }}
          GRYPE_COMMENT_PATH: grype-comment.md
          GRYPE_REPORT_PATH: grype-report.json
        run: python3 .github/scripts/grype_summary.py

      - name: Comment PR with Grype results
        if: github.event_name == 'pull_request' && steps.format-report.outputs.comment_path != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentPath = '${{ steps.format-report.outputs.comment_path }}';
            let body = 'Grype 扫描已完成，但未能生成报告。';
            try {
              body = fs.readFileSync(commentPath, 'utf8');
            } catch (error) {
              core.warning(`读取 Grype 评论文件失败: ${error.message}`);
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Fail if blocking vulnerabilities detected
        if: steps.grype.outputs.exit_code != '' && steps.grype.outputs.exit_code != '0'
        run: |
          echo "Grype 检测到达到 ${GRYPE_FAIL_ON_SEVERITY} 阈值的漏洞 (退出码 ${{ steps.grype.outputs.exit_code }})"
          exit 1
