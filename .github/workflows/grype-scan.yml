name: Grype Vulnerability Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  grype-scan:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: -Dorg.gradle.daemon=false
      GRYPE_DB_CACHE_DIR: ~/.cache/grype/db
      GRYPE_FAIL_ON_SEVERITY: high
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build project (fetch dependencies)
        run: ./gradlew --no-daemon clean build

      - name: Prepare Grype cache directory
        run: mkdir -p ~/.cache/grype/db

      - name: Cache Grype vulnerability database
        uses: actions/cache@v4
        with:
          path: ~/.cache/grype/db
          key: grype-db-${{ runner.os }}-v1
          restore-keys: |
            grype-db-${{ runner.os }}-

      - name: Generate CycloneDX SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom.cdx.json

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | \
            sh -s -- -b /usr/local/bin

      - name: Run Grype scan
        id: grype
        continue-on-error: true
        run: |
          set +e
          grype sbom:sbom.cdx.json \
            --fail-on "${GRYPE_FAIL_ON_SEVERITY}" \
            --add-cpes-if-none \
            -o json \
            > grype-report.json
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "Grype exited with code $EXIT_CODE due to detected vulnerabilities."
          else
            echo "Grype completed without hitting the fail-on threshold."
          fi
          exit 0

      - name: Upload SBOM and Grype report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grype-results
          path: |
            sbom.cdx.json
            grype-report.json

      - name: Generate Grype summary & comment
        id: format-report
        if: always()
        env:
          FAIL_ON_SEVERITY: ${{ env.GRYPE_FAIL_ON_SEVERITY }}
        run: |
          python <<'PY'
            import json
            import os
            from collections import defaultdict

            report_path = "grype-report.json"
            summary_path = os.environ.get("GITHUB_STEP_SUMMARY")
            fail_on = os.environ.get("FAIL_ON_SEVERITY", "high").capitalize()
            sha = os.environ.get("GITHUB_SHA", "")[:7]
            severity_order = ["Critical", "High", "Medium", "Low", "Negligible", "Unknown"]
            severity_rank = {name: idx for idx, name in enumerate(severity_order)}

            if os.path.exists(report_path) and os.path.getsize(report_path) > 0:
                with open(report_path, "r", encoding="utf-8") as fh:
                    data = json.load(fh)
                matches = data.get("matches", [])
            else:
                matches = []

            counts = defaultdict(int)
            packages = {}
            for match in matches:
                vuln = match.get("vulnerability", {})
                artifact = match.get("artifact", {})
                severity = (vuln.get("severity") or "Unknown").capitalize()
                counts[severity] += 1
                pkg = artifact.get("name", "unknown")
                version = artifact.get("version", "unknown")
                key = f"{pkg}@{version}"
                entry = packages.setdefault(
                    key,
                    {"name": pkg, "version": version, "severities": set(), "ids": set()},
                )
                entry["severities"].add(severity)
                vuln_id = vuln.get("id") or vuln.get("dataSource") or "N/A"
                entry["ids"].add(vuln_id)

            def entry_score(item):
                severities = item["severities"] or {"Unknown"}
                return min(severity_rank.get(sev, len(severity_order)) for sev in severities)

            top_packages = sorted(
                packages.values(),
                key=lambda item: (entry_score(item), -len(item["ids"]))
            )[:5]

            def format_severities(values):
                return ", ".join(
                    sorted(values, key=lambda s: severity_rank.get(s, len(severity_order)))
                )

            def format_ids(values):
                return "<br>".join(sorted(values)) if values else "-"

            summary_lines = [
                "## Grype æ‰«ææ‘˜è¦",
                f"- è§¦å‘æäº¤ï¼š`{sha}`",
                f"- å¤±è´¥é˜ˆå€¼ï¼š{fail_on} åŠä»¥ä¸Š",
                f"- æ€»åŒ¹é…æ¼æ´æ•°ï¼š{len(matches)}",
            ]

            comment_lines = summary_lines.copy()

            if matches:
                summary_lines.append("")
                summary_lines.append("### ä¸¥é‡ç­‰çº§åˆ†å¸ƒ")
                for sev in severity_order:
                    if counts.get(sev):
                        summary_lines.append(f"- {sev}: {counts[sev]}")

                comment_lines.append("")
                comment_lines.append("### ğŸ“¦ é«˜ä¼˜å…ˆçº§ä¾èµ–ï¼ˆæœ€å¤š 5 ä¸ªï¼‰")
                comment_lines.append("| ä¾èµ– | ç‰ˆæœ¬ | ä¸¥é‡ç­‰çº§ | æ¼æ´ ID |")
                comment_lines.append("| ---- | ---- | -------- | ------- |")
                for pkg in top_packages:
                    comment_lines.append(
                        f"| `{pkg['name']}` | `{pkg['version']}` | {format_severities(pkg['severities'])} | {format_ids(pkg['ids'])} |"
                    )
            else:
                comment_lines.append("")
                comment_lines.append("âœ… æœªæ£€æµ‹åˆ°è¾¾åˆ°é˜ˆå€¼çš„æ¼æ´ã€‚")

            comment_body = "\n".join(comment_lines) + "\n"

            with open("grype-comment.md", "w", encoding="utf-8") as fh:
                fh.write(comment_body)

            if summary_path:
                with open(summary_path, "a", encoding="utf-8") as fh:
                    fh.write("\n".join(summary_lines))
                    fh.write("\n")

            with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
                fh.write(f"has_vulns={'true' if matches else 'false'}\n")
                fh.write("comment_path=grype-comment.md\n")
          PY

      - name: Comment PR with Grype results
        if: github.event_name == 'pull_request' && steps.format-report.outputs.comment_path != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = 'Grype æ‰«æå·²å®Œæˆï¼Œä½†æœªèƒ½ç”ŸæˆæŠ¥å‘Šã€‚';
            try {
              body = fs.readFileSync('grype-comment.md', 'utf8');
            } catch (error) {
              core.warning(`è¯»å– Grype è¯„è®ºæ–‡ä»¶å¤±è´¥: ${error.message}`);
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Fail if blocking vulnerabilities detected
        if: steps.grype.outputs.exit_code != '' && steps.grype.outputs.exit_code != '0'
        run: |
          echo "Grype æ£€æµ‹åˆ°è¾¾åˆ° ${GRYPE_FAIL_ON_SEVERITY} é˜ˆå€¼çš„æ¼æ´ (é€€å‡ºç  ${{ steps.grype.outputs.exit_code }})"
          exit 1
